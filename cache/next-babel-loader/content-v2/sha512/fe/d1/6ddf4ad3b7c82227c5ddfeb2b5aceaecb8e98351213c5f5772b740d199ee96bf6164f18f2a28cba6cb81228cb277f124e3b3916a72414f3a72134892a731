{"ast":null,"code":"import { jsx as _jsx } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport React, { useState, useEffect } from \"react\";\nimport Head from \"next/head\";\nimport NextLink from \"next/link\";\nimport NextImage from \"next/image\";\nimport { useRouter } from \"next/router\";\nimport { getETHPrice, getWEIPriceInUSD } from \"../../../../lib/getETHPrice\";\nimport { Heading, useBreakpointValue, useColorModeValue, Text, Button, Flex, Container, SimpleGrid, Box, Spacer, Table, Thead, Tbody, Tooltip, Tr, Th, Td, TableCaption, Skeleton, Alert, AlertIcon, AlertDescription, HStack, Stack, Link } from \"@chakra-ui/react\";\nimport { ArrowBackIcon, InfoIcon, CheckCircleIcon, WarningIcon } from \"@chakra-ui/icons\";\nimport web3 from \"../../../../smart-contract/web3\";\nimport Campaign from \"../../../../smart-contract/campaign\";\nimport factory from \"../../../../smart-contract/factory\";\nexport async function getServerSideProps({\n  params\n}) {\n  const campaignId = params.id;\n  const campaign = Campaign(campaignId);\n  const requestCount = await campaign.methods.getRequestsCount().call();\n  const approversCount = await campaign.methods.approversCount().call();\n  const summary = await campaign.methods.getSummary().call();\n  const ETHPrice = await getETHPrice();\n  return {\n    props: {\n      campaignId,\n      requestCount,\n      approversCount,\n      balance: summary[1],\n      name: summary[5],\n      ETHPrice\n    }\n  };\n}\n\nconst RequestRow = ({\n  id,\n  request,\n  approversCount,\n  campaignId,\n  disabled,\n  ETHPrice\n}) => {\n  const router = useRouter();\n  const readyToFinalize = request.approvalCount > approversCount / 2;\n  const {\n    0: errorMessageApprove,\n    1: setErrorMessageApprove\n  } = useState();\n  const {\n    0: loadingApprove,\n    1: setLoadingApprove\n  } = useState(false);\n  const {\n    0: errorMessageFinalize,\n    1: setErrorMessageFinalize\n  } = useState();\n  const {\n    0: loadingFinalize,\n    1: setLoadingFinalize\n  } = useState(false);\n\n  const onApprove = async () => {\n    setLoadingApprove(true);\n\n    try {\n      const campaign = Campaign(campaignId);\n      const accounts = await web3.eth.getAccounts();\n      await campaign.methods.approveRequest(id).send({\n        from: accounts[0]\n      });\n      router.reload();\n    } catch (err) {\n      setErrorMessageApprove(err.message);\n    } finally {\n      setLoadingApprove(false);\n    }\n  };\n\n  const onFinalize = async () => {\n    setLoadingFinalize(true);\n\n    try {\n      const campaign = Campaign(campaignId);\n      const accounts = await web3.eth.getAccounts();\n      await campaign.methods.finalizeRequest(id).send({\n        from: accounts[0]\n      });\n      router.reload();\n    } catch (err) {\n      setErrorMessageFinalize(err.message);\n    } finally {\n      setLoadingFinalize(false);\n    }\n  };\n\n  return /*#__PURE__*/_jsxs(Tr, {\n    bg: readyToFinalize && !request.complete ? useColorModeValue(\"teal.100\", \"teal.700\") : useColorModeValue(\"gray.100\", \"gray.700\"),\n    opacity: request.complete ? \"0.4\" : \"1\",\n    children: [/*#__PURE__*/_jsxs(Td, {\n      children: [id, \" \"]\n    }), /*#__PURE__*/_jsx(Td, {\n      children: request.description\n    }), /*#__PURE__*/_jsxs(Td, {\n      isNumeric: true,\n      children: [web3.utils.fromWei(request.value, \"ether\"), \"ETH ($\", getWEIPriceInUSD(ETHPrice, request.value), \")\"]\n    }), /*#__PURE__*/_jsx(Td, {\n      children: /*#__PURE__*/_jsxs(Link, {\n        color: \"teal.500\",\n        href: `https://rinkeby.etherscan.io/address/${request.recipient}`,\n        isExternal: true,\n        children: [\" \", request.recipient.substr(0, 10) + \"...\"]\n      })\n    }), /*#__PURE__*/_jsxs(Td, {\n      children: [request.approvalCount, \"/\", approversCount]\n    }), /*#__PURE__*/_jsx(Td, {\n      children: /*#__PURE__*/_jsxs(HStack, {\n        spacing: 2,\n        children: [/*#__PURE__*/_jsx(Tooltip, {\n          label: errorMessageApprove,\n          bg: useColorModeValue(\"white\", \"gray.700\"),\n          placement: \"top\",\n          color: useColorModeValue(\"gray.800\", \"white\"),\n          fontSize: \"1em\",\n          children: /*#__PURE__*/_jsx(WarningIcon, {\n            color: useColorModeValue(\"red.600\", \"red.300\"),\n            display: errorMessageApprove ? \"inline-block\" : \"none\"\n          })\n        }), request.complete ? /*#__PURE__*/_jsx(Tooltip, {\n          label: \"This Request has been finalized & withdrawn to the recipient,it may then have less no of approvers\",\n          bg: useColorModeValue(\"white\", \"gray.700\"),\n          placement: \"top\",\n          color: useColorModeValue(\"gray.800\", \"white\"),\n          fontSize: \"1em\",\n          children: /*#__PURE__*/_jsx(CheckCircleIcon, {\n            color: useColorModeValue(\"green.600\", \"green.300\")\n          })\n        }) : /*#__PURE__*/_jsx(Button, {\n          colorScheme: \"yellow\",\n          variant: \"outline\",\n          _hover: {\n            bg: \"yellow.600\",\n            color: \"white\"\n          },\n          onClick: onApprove,\n          isDisabled: disabled || request.approvalCount == approversCount,\n          isLoading: loadingApprove,\n          children: \"Approve\"\n        })]\n      })\n    }), /*#__PURE__*/_jsxs(Td, {\n      children: [/*#__PURE__*/_jsx(Tooltip, {\n        label: errorMessageFinalize,\n        bg: useColorModeValue(\"white\", \"gray.700\"),\n        placement: \"top\",\n        color: useColorModeValue(\"gray.800\", \"white\"),\n        fontSize: \"1em\",\n        children: /*#__PURE__*/_jsx(WarningIcon, {\n          color: useColorModeValue(\"red.600\", \"red.300\"),\n          display: errorMessageFinalize ? \"inline-block\" : \"none\",\n          mr: \"2\"\n        })\n      }), request.complete ? /*#__PURE__*/_jsx(Tooltip, {\n        label: \"This Request has been finalized & withdrawn to the recipient,it may then have less no of approvers\",\n        bg: useColorModeValue(\"white\", \"gray.700\"),\n        placement: \"top\",\n        color: useColorModeValue(\"gray.800\", \"white\"),\n        fontSize: \"1em\",\n        children: /*#__PURE__*/_jsx(CheckCircleIcon, {\n          color: useColorModeValue(\"green.600\", \"green.300\")\n        })\n      }) : /*#__PURE__*/_jsxs(HStack, {\n        spacing: 2,\n        children: [/*#__PURE__*/_jsx(Button, {\n          colorScheme: \"green\",\n          variant: \"outline\",\n          _hover: {\n            bg: \"green.600\",\n            color: \"white\"\n          },\n          isDisabled: disabled || !request.complete && !readyToFinalize,\n          onClick: onFinalize,\n          isLoading: loadingFinalize,\n          children: \"Finalize\"\n        }), /*#__PURE__*/_jsx(Tooltip, {\n          label: \"This Request is ready to be Finalized because it has been approved by 50% Approvers\",\n          bg: useColorModeValue(\"white\", \"gray.700\"),\n          placement: \"top\",\n          color: useColorModeValue(\"gray.800\", \"white\"),\n          fontSize: \"1.2em\",\n          children: /*#__PURE__*/_jsx(InfoIcon, {\n            as: \"span\",\n            color: useColorModeValue(\"teal.800\", \"white\"),\n            display: readyToFinalize && !request.complete ? \"inline-block\" : \"none\"\n          })\n        })]\n      })]\n    })]\n  });\n};\n\nexport default function Requests({\n  campaignId,\n  requestCount,\n  approversCount,\n  balance,\n  name,\n  ETHPrice\n}) {\n  const {\n    0: requestsList,\n    1: setRequestsList\n  } = useState([]);\n  const {\n    0: isLoading,\n    1: setIsLoading\n  } = useState(true);\n  const {\n    0: FundNotAvailable,\n    1: setFundNotAvailable\n  } = useState(false);\n  const campaign = Campaign(campaignId);\n\n  async function getRequests() {\n    try {\n      const requests = await Promise.all(Array(parseInt(requestCount)).fill().map((element, index) => {\n        return campaign.methods.requests(index).call();\n      }));\n      console.log(\"requests\", requests);\n      setRequestsList(requests);\n      setIsLoading(false);\n      return requests;\n    } catch (e) {\n      console.log(e);\n    }\n  }\n\n  useEffect(() => {\n    if (balance == 0) {\n      setFundNotAvailable(true);\n    }\n\n    getRequests();\n  }, []);\n  return /*#__PURE__*/_jsxs(\"div\", {\n    children: [/*#__PURE__*/_jsxs(Head, {\n      children: [/*#__PURE__*/_jsx(\"title\", {\n        children: \"Campaign Withdrawal Requests\"\n      }), /*#__PURE__*/_jsx(\"meta\", {\n        name: \"description\",\n        content: \"Create a Withdrawal Request\"\n      }), /*#__PURE__*/_jsx(\"link\", {\n        rel: \"icon\",\n        href: \"/logo.svg\"\n      })]\n    }), /*#__PURE__*/_jsxs(\"main\", {\n      children: [/*#__PURE__*/_jsxs(Container, {\n        px: {\n          base: \"4\",\n          md: \"12\"\n        },\n        maxW: \"7xl\",\n        align: \"left\",\n        children: [/*#__PURE__*/_jsxs(Flex, {\n          flexDirection: {\n            base: \"column\",\n            md: \"row\"\n          },\n          py: 4,\n          children: [/*#__PURE__*/_jsx(Box, {\n            py: \"4\",\n            children: /*#__PURE__*/_jsxs(Text, {\n              fontSize: \"lg\",\n              color: \"teal.400\",\n              children: [/*#__PURE__*/_jsx(ArrowBackIcon, {\n                mr: 2\n              }), /*#__PURE__*/_jsx(NextLink, {\n                href: `/campaign/${campaignId}`,\n                children: \"Back to Campaign\"\n              })]\n            })\n          }), /*#__PURE__*/_jsx(Spacer, {}), /*#__PURE__*/_jsxs(Box, {\n            py: \"4\",\n            children: [\"Campaign Balance :\", \" \", /*#__PURE__*/_jsx(Text, {\n              as: \"span\",\n              fontWeight: \"bold\",\n              fontSize: \"lg\",\n              children: balance > 0 ? web3.utils.fromWei(balance, \"ether\") : \"0, Become a Donor 😄\"\n            }), /*#__PURE__*/_jsxs(Text, {\n              as: \"span\",\n              display: balance > 0 ? \"inline\" : \"none\",\n              pr: 2,\n              fontWeight: \"bold\",\n              fontSize: \"lg\",\n              children: [\" \", \"ETH\"]\n            }), /*#__PURE__*/_jsxs(Text, {\n              as: \"span\",\n              display: balance > 0 ? \"inline\" : \"none\",\n              fontWeight: \"normal\",\n              color: useColorModeValue(\"gray.500\", \"gray.200\"),\n              children: [\"($\", getWEIPriceInUSD(ETHPrice, balance), \")\"]\n            })]\n          })]\n        }), FundNotAvailable ? /*#__PURE__*/_jsxs(Alert, {\n          status: \"error\",\n          my: 4,\n          children: [/*#__PURE__*/_jsx(AlertIcon, {}), /*#__PURE__*/_jsx(AlertDescription, {\n            children: \"The Current Balance of the Campaign is 0, Please Contribute to approve and finalize Requests.\"\n          })]\n        }) : null]\n      }), requestsList.length > 0 ? /*#__PURE__*/_jsxs(Container, {\n        px: {\n          base: \"4\",\n          md: \"12\"\n        },\n        maxW: \"7xl\",\n        align: \"left\",\n        children: [/*#__PURE__*/_jsxs(Flex, {\n          flexDirection: {\n            base: \"column\",\n            lg: \"row\"\n          },\n          py: 4,\n          children: [/*#__PURE__*/_jsx(Box, {\n            py: \"2\",\n            pr: \"2\",\n            children: /*#__PURE__*/_jsxs(Heading, {\n              textAlign: useBreakpointValue({\n                base: \"left\"\n              }),\n              fontFamily: \"heading\",\n              color: useColorModeValue(\"gray.800\", \"white\"),\n              as: \"h3\",\n              isTruncated: true,\n              maxW: \"3xl\",\n              children: [\"Withdrawal Requests for \", name, \" Campaign\"]\n            })\n          }), /*#__PURE__*/_jsx(Spacer, {}), /*#__PURE__*/_jsx(Box, {\n            py: \"2\",\n            children: /*#__PURE__*/_jsx(NextLink, {\n              href: `/campaign/${campaignId}/requests/new`,\n              children: /*#__PURE__*/_jsx(Button, {\n                display: {\n                  sm: \"inline-flex\"\n                },\n                justify: \"flex-end\",\n                fontSize: \"md\",\n                fontWeight: 600,\n                color: \"white\",\n                bg: \"teal.400\",\n                href: \"#\",\n                _hover: {\n                  bg: \"teal.300\"\n                },\n                children: \"Add Withdrawal Request\"\n              })\n            })\n          })]\n        }), \" \", /*#__PURE__*/_jsx(Box, {\n          overflowX: \"auto\",\n          children: /*#__PURE__*/_jsxs(Table, {\n            children: [/*#__PURE__*/_jsx(Thead, {\n              children: /*#__PURE__*/_jsxs(Tr, {\n                children: [/*#__PURE__*/_jsx(Th, {\n                  children: \"ID\"\n                }), /*#__PURE__*/_jsx(Th, {\n                  w: \"30%\",\n                  children: \"Description\"\n                }), /*#__PURE__*/_jsx(Th, {\n                  isNumeric: true,\n                  children: \"Amount\"\n                }), /*#__PURE__*/_jsx(Th, {\n                  maxW: \"12%\",\n                  isTruncated: true,\n                  children: \"Recipient Wallet Address\"\n                }), /*#__PURE__*/_jsx(Th, {\n                  children: \"Approval Count \"\n                }), /*#__PURE__*/_jsx(Th, {\n                  children: \"Approve \"\n                }), /*#__PURE__*/_jsx(Th, {\n                  children: \"Finalize \"\n                })]\n              })\n            }), /*#__PURE__*/_jsx(Tbody, {\n              children: requestsList.map((request, index) => {\n                return /*#__PURE__*/_jsx(RequestRow, {\n                  id: index,\n                  request: request,\n                  approversCount: approversCount,\n                  campaignId: campaignId,\n                  disabled: FundNotAvailable,\n                  ETHPrice: ETHPrice\n                }, index);\n              })\n            }), /*#__PURE__*/_jsxs(TableCaption, {\n              textAlign: \"left\",\n              ml: \"-2\",\n              children: [\"Found \", requestCount, \" Requests\"]\n            })]\n          })\n        })]\n      }) : /*#__PURE__*/_jsxs(\"div\", {\n        children: [/*#__PURE__*/_jsx(Container, {\n          px: {\n            base: \"4\",\n            md: \"12\"\n          },\n          maxW: \"7xl\",\n          align: \"left\",\n          display: isLoading ? \"block\" : \"none\",\n          children: /*#__PURE__*/_jsxs(SimpleGrid, {\n            rows: {\n              base: 3\n            },\n            spacing: 2,\n            children: [/*#__PURE__*/_jsx(Skeleton, {\n              height: \"2rem\"\n            }), /*#__PURE__*/_jsx(Skeleton, {\n              height: \"5rem\"\n            }), /*#__PURE__*/_jsx(Skeleton, {\n              height: \"5rem\"\n            }), /*#__PURE__*/_jsx(Skeleton, {\n              height: \"5rem\"\n            })]\n          })\n        }), /*#__PURE__*/_jsx(Container, {\n          maxW: \"lg\",\n          align: \"center\",\n          display: requestsList.length === 0 && !isLoading ? \"block\" : \"none\",\n          children: /*#__PURE__*/_jsxs(SimpleGrid, {\n            row: true,\n            spacing: 2,\n            align: \"center\",\n            children: [/*#__PURE__*/_jsx(Stack, {\n              align: \"center\",\n              children: /*#__PURE__*/_jsx(NextImage, {\n                src: \"/static/no-requests.png\",\n                alt: \"no-request\",\n                width: \"150\",\n                height: \"150\"\n              })\n            }), /*#__PURE__*/_jsxs(Heading, {\n              textAlign: \"center\",\n              color: useColorModeValue(\"gray.800\", \"white\"),\n              as: \"h4\",\n              size: \"md\",\n              children: [\"No Requests yet for \", name, \" Campaign\"]\n            }), /*#__PURE__*/_jsx(Text, {\n              textAlign: useBreakpointValue({\n                base: \"center\"\n              }),\n              color: useColorModeValue(\"gray.600\", \"gray.300\"),\n              fontSize: \"sm\",\n              children: \"Create a Withdrawal Request to Withdraw funds from the Campaign\\uD83D\\uDE04\"\n            }), /*#__PURE__*/_jsx(Button, {\n              fontSize: \"md\",\n              fontWeight: 600,\n              color: \"white\",\n              bg: \"teal.400\",\n              _hover: {\n                bg: \"teal.300\"\n              },\n              children: /*#__PURE__*/_jsx(NextLink, {\n                href: `/campaign/${campaignId}/requests/new`,\n                children: \"Create Withdrawal Request\"\n              })\n            }), /*#__PURE__*/_jsx(Button, {\n              fontSize: \"md\",\n              fontWeight: 600,\n              color: \"white\",\n              bg: \"gray.400\",\n              _hover: {\n                bg: \"gray.300\"\n              },\n              children: /*#__PURE__*/_jsx(NextLink, {\n                href: `/campaign/${campaignId}/`,\n                children: \"Go to Campaign\"\n              })\n            })]\n          })\n        })]\n      })]\n    })]\n  });\n}","map":null,"metadata":{},"sourceType":"module"}